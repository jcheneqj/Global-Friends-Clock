<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link rel="manifest" href="/manifest.json"> 
    <title>Global Friends Clock Ultimate</title>
    <style>
        :root {
            --orange: #FF9500;
            --glass: rgba(255, 255, 255, 0.1);
            --font-main: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        }

        body {
            background-color: #000;
            color: white; margin: 0; padding: 20px;
            font-family: var(--font-main); 
            display: flex; flex-direction: column; align-items: center;
            min-height: 100vh;
            transition: background-color 0.1s linear;
            
            /* ç¦ç”¨æ‰‹æ©Ÿæ–‡å­—é¸å–èˆ‡é•·æŒ‰é¸å–® */
            -webkit-user-select: none;
            -webkit-touch-callout: none;
            user-select: none;
        }

        .header { text-align: center; margin-top: 20px; z-index: 10; height: 110px; }
        .time-display { font-size: 4.5rem; font-weight: 200; margin: 0; line-height: 1; }
        .status-msg { font-size: 1.1rem; opacity: 0.6; letter-spacing: 2px; margin-top: 10px; text-transform: uppercase; }

        .clock-container { 
            position: relative; 
            margin: 10px 0; 
            touch-action: none; 
            z-index: 5; 
            cursor: grab; /* ä½¿ç”¨åŸç”ŸæŠ“å–æ‰‹å‹¢ */
        }
        .clock-container:active { cursor: grabbing; }

        canvas { max-width: 90vw; max-height: 45vh; }

        .controls-panel { width: 100%; max-width: 500px; display: flex; flex-direction: column; align-items: center; gap: 20px; z-index: 10; }
        .friends-list { display: flex; gap: 10px; flex-wrap: wrap; justify-content: center; }

        button {
            padding: 10px 22px; border-radius: 25px; border: 1px solid rgba(255,255,255,0.2);
            background: var(--glass); color: white; cursor: pointer; transition: 0.3s;
            backdrop-filter: blur(15px); font-size: 0.9rem; outline: none;
        }
        button.active { background: white; color: black; border-color: white; font-weight: bold; }
        
        .action-row { display: flex; gap: 12px; align-items: center; }
        .add-btn { width: 45px; height: 45px; border-radius: 50%; font-size: 26px; display: flex; align-items: center; justify-content: center; padding: 0; background: #222; }
        .reset-btn { color: #ff3b30; border-color: rgba(255, 59, 48, 0.4); }
        .work-btn.on { border-color: var(--orange); color: var(--orange); }

        /* ä¿®æ”¹å¾Œçš„ Modal æ¨£å¼ */
.modal-overlay {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.85); /* ç¨å¾®æ·±ä¸€é»å¢åŠ å°æ¯” */
    display: none; justify-content: center; align-items: center;
    z-index: 100; backdrop-filter: blur(15px);
}

.modal-content { 
    background: #8F8F8F; /* æ”¹æˆæ·±è‰²ç³»æ›´ç¬¦åˆ Apple é¢¨æ ¼ */
    color: white;
    width: 85%; 
    max-width: 350px; 
    max-height: 80vh; /* é™åˆ¶æœ€é«˜ç‚ºè¢å¹•çš„ 80% */
    border-radius: 30px; 
    padding: 25px; 
    display: flex; 
    flex-direction: column; /* è®“å…§å®¹å‚ç›´æ’åˆ— */
}

#cityList {
    overflow-y: auto; /* é–‹å•Ÿå‚ç›´æ²å‹• */
    flex: 1; /* è‡ªå‹•å¡«æ»¿å‰©é¤˜ç©ºé–“ */
    margin-bottom: 10px;
    padding-right: 5px; /* çµ¦æ²è»¸ä¸€é»ç©ºé–“ */
}

/* è®“æ²è»¸æ¼‚äº®ä¸€é»ï¼ˆéš±è—æˆ–ç°¡ç´„åŒ–ï¼‰ */
#cityList::-webkit-scrollbar {
    width: 4px;
}
#cityList::-webkit-scrollbar-thumb {
    background: rgba(255,255,255,0.2);
    border-radius: 10px;
}

.city-item { 
    padding: 18px 0; 
    border-bottom: 1px solid rgba(255,255,255,0.1); 
    cursor: pointer; 
    display: flex; 
    justify-content: space-between; 
    transition: 0.2s; 
}
.city-item:active { background: rgba(255,255,255,0.1); } /* é»é¸å›é¥‹ */

        .hint { font-size: 0.7rem; opacity: 0.4; margin-top: 25px; letter-spacing: 1.5px; text-transform: uppercase; text-align: center; }
    </style>
       <link rel="manifest" href="manifest.json">
      <meta name="theme-color" content="#000000">
      <meta name="apple-mobile-web-app-capable" content="yes">
      <link rel="apple-touch-icon" href="icon-192.png">
</head>

<script>
if ("serviceWorker" in navigator) {
  navigator.serviceWorker.register("sw.js");
}
</script>

<body>
    <div class="header">
        <h1 class="time-display" id="clockTime">00:00</h1>
        <p class="status-msg" id="statusLabel">TAIWAN</p>
    </div>
    
    <div class="clock-container" id="clockWrapper">
        <canvas id="clock" width="500" height="500"></canvas>
    </div>

    <div class="controls-panel">
        <div class="friends-list" id="btnGroup"></div>
        <div class="action-row">
            <button class="add-btn" onclick="openModal()">+</button>
            <button class="work-btn" id="workToggle" onclick="toggleWorkMode()">WORK</button>
            <button class="reset-btn" onclick="resetTime()">RESET</button>
        </div>
        <p class="hint">Spin the clock to travel | Work from 9:00-17:00</p>
    </div>

    <div class="modal-overlay" id="modalOverlay" onclick="closeModal()">
        <div class="modal-content" onclick="event.stopPropagation()">
            <h3 style="margin: 0 0 20px 0; font-weight: 400; text-align: center;">Add City</h3>
            <div id="cityList"></div>
            <button style="width: 100%; margin-top: 15px; background: #444; border: none; color: white; border-radius: 15px; height: 45px;" onclick="closeModal()">CANCEL</button>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('clock');
        const ctx = canvas.getContext('2d');
        const clockWrapper = document.getElementById('clockWrapper');

        let friends = [{ name: "Taiwan", zone: "Asia/Taipei", id: 1 }];
        const allCities = [
            { name: "Estonia", zone: "Europe/Tallinn" }, { name: "France", zone: "Europe/Paris" },
            { name: "Japan", zone: "Asia/Tokyo" }, { name: "London", zone: "Europe/London" },
            { name: "Mexico City", zone: "America/Mexico_City" }, { name: "New York", zone: "America/New_York" },
            { name: "India", zone: "Asia/Kolkata" }, { name: "Portugal", zone: "Europe/Lisbon" },
            { name: "Ukraine", zone: "Europe/Kiev" }, { name: "Sydney", zone: "Australia/Sydney" },
            { name: "Turkey", zone: "Europe/Istanbul" }, { name: "California", zone: "America/Los_Angeles" }
        ];

        const hourColors = { 0: "#0a0a14", 5: "#97739E", 8: "#2980b9", 12: "#64C9ED", 17: "#d35400", 19: "#2c3e50", 22: "#0f0f0f" };

        let selectedId = friends[0].id, manualOffset = 0, isDragging = false, lastAngle = 0, showWorkMode = false;

        function getZonedTime(date, timeZone) {
            const parts = new Intl.DateTimeFormat('en-US', { timeZone, hour12: false, year:'numeric', month:'numeric', day:'numeric', hour:'numeric', minute:'numeric', second:'numeric' }).formatToParts(date);
            const p = {}; parts.forEach(part => p[part.type] = part.value);
            return {
                day: parseInt(p.day), hour: parseInt(p.hour), minute: parseInt(p.minute), second: parseInt(p.second),
                absDay: new Date(new Intl.DateTimeFormat('en-US', {timeZone}).format(date)).getTime() / 86400000
            };
        }

        function getInterpolatedColor(h) {
            const hours = Object.keys(hourColors).map(Number).sort((a,b)=>a-b);
            let h1, h2;
            if (h >= hours[hours.length-1]) { h1 = hours[hours.length-1]; h2 = hours[0]+24; }
            else { for (let i=0; i<hours.length-1; i++) { if (h >= hours[i] && h < hours[i+1]) { h1 = hours[i]; h2 = hours[i+1]; break; } } }
            const c1 = hexToRgb(hourColors[h1%24]), c2 = hexToRgb(hourColors[h2%24]);
            const r = (h-h1)/(h2-h1), m = (v1,v2)=>Math.round(v1+(v2-v1)*r);
            return `rgb(${m(c1.r,c2.r)}, ${m(c1.g,c2.g)}, ${m(c1.b,c2.b)})`;
        }

        function hexToRgb(hex) {
            const r = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
            return r ? { r:parseInt(r[1],16), g:parseInt(r[2],16), b:parseInt(r[3],16) } : {r:0,g:0,b:0};
        }

        function getAngle(e) {
            const rect = canvas.getBoundingClientRect();
            const cx = rect.left + rect.width/2, cy = rect.top + rect.height/2;
            const ex = e.touches ? e.touches[0].clientX : e.clientX, ey = e.touches ? e.touches[0].clientY : e.clientY;
            return Math.atan2(ey - cy, ex - cx);
        }

        // --- äº’å‹•äº‹ä»¶ ---
        clockWrapper.onmousedown = (e) => { isDragging = true; lastAngle = getAngle(e); };
        window.onmousemove = (e) => {
            if (!isDragging) return;
            let a = getAngle(e), da = a - lastAngle;
            if (da > Math.PI) da -= Math.PI*2; if (da < -Math.PI) da += Math.PI*2;
            manualOffset += da * (720 / (Math.PI*2)); 
            lastAngle = a;
        };
        window.onmouseup = () => isDragging = false;
        clockWrapper.addEventListener("touchstart", (e) => { isDragging = true; lastAngle = getAngle(e); }, {passive:false});
        clockWrapper.addEventListener("touchmove", (e) => {
            if (!isDragging) return; e.preventDefault();
            let a = getAngle(e), da = a - lastAngle;
            if (da > Math.PI) da -= Math.PI*2; if (da < -Math.PI) da += Math.PI*2;
            manualOffset += da * (720 / (Math.PI*2)); lastAngle = a;
        }, {passive:false});
        window.addEventListener("touchend", () => isDragging = false);
     

        // --- åŠŸèƒ½æ¨¡çµ„ ---
        function init() {
            const list = document.getElementById('cityList');
            allCities.forEach(c => {
                const d = document.createElement('div'); d.className = 'city-item';
                d.innerHTML = `<span>${c.name}</span><span style="opacity:0.4">${c.zone.split('/')[0]}</span>`;
                d.onclick = () => addFriend(c); list.appendChild(d);
            });
            renderButtons(); requestAnimationFrame(animate);
        }

        function renderButtons() {
            const g = document.getElementById('btnGroup'); 
            g.innerHTML = "";
            
            friends.forEach(f => {
                const b = document.createElement('button'); 
                b.innerText = f.name;
                if (f.id === selectedId) b.classList.add('active');

                let longPressTimer;
                let isDeleted = false;

                // --- é»æ“Šåˆ‡æ› ---
                b.onclick = () => { 
                    if (isDeleted) return; // å¦‚æœå‰›è¢«åˆªé™¤å°±ä¸è§¸ç™¼é¸å–
                    selectedId = f.id; 
                    updateActiveButtonUI(); 
                };

                // --- æ‰‹æ©Ÿç‰ˆï¼šè‡ªå®šç¾©é•·æŒ‰åˆªé™¤ ---
                b.addEventListener('touchstart', (e) => {
                    isDeleted = false;
                    longPressTimer = setTimeout(() => {
                        if (friends.length > 1) {
                            if (navigator.vibrate) navigator.vibrate(40); // éœ‡å‹•ä¸€ä¸‹ä»£è¡¨åˆªé™¤
                            isDeleted = true;
                            executeDelete(f.id);
                        }
                    }, 600); // é•·æŒ‰ 0.6 ç§’
                }, { passive: true });

                b.addEventListener('touchend', () => clearTimeout(longPressTimer));
                b.addEventListener('touchmove', () => clearTimeout(longPressTimer));

                // --- æ¡Œæ©Ÿç‰ˆï¼šå³éµç«‹åˆ»åˆªé™¤ ---
                b.oncontextmenu = (e) => { 
                    e.preventDefault(); 
                    if (friends.length > 1) executeDelete(f.id);
                };

                g.appendChild(b);
            });
        }

        // æ ¸å¿ƒåˆªé™¤å‹•ä½œ
        function executeDelete(id) {
            friends = friends.filter(i => i.id !== id);
            // å¦‚æœåˆªæ‰çš„æ˜¯ç•¶å‰é¸ä¸­çš„ï¼Œåˆ‡æ›åˆ°å‰©ä¸‹çš„ç¬¬ä¸€å€‹
            if (selectedId === id) selectedId = friends[0].id;
            renderButtons();
        }

       

        function updateActiveButtonUI() {
            const btns = document.querySelectorAll('.friends-list button');
            friends.forEach((f, i) => { if(btns[i]) f.id === selectedId ? btns[i].classList.add('active') : btns[i].classList.remove('active'); });
        }

        function addFriend(c) { if (friends.length < 5) { friends.push({ ...c, id: Date.now() }); renderButtons(); closeModal(); } }
        function openModal() { document.getElementById('modalOverlay').style.display = 'flex'; }
        function closeModal() { document.getElementById('modalOverlay').style.display = 'none'; }
        function resetTime() { manualOffset = 0; }
        function toggleWorkMode() { 
            showWorkMode = !showWorkMode; 
            document.getElementById('workToggle').className = `work-btn ${showWorkMode?'on':''}`; 
        }

        function animate() {
            const now = new Date(), travelTime = new Date(now.getTime() + manualOffset * 60000);
            const focus = friends.find(f => f.id === selectedId) || friends[0], fLoc = getZonedTime(travelTime, focus.zone);
            
            // å‘¼å¸å…‰è¨ˆç®—
            const pulse = (Math.sin(Date.now() / 500) + 1) / 2; 

            document.body.style.backgroundColor = getInterpolatedColor(fLoc.hour + fLoc.minute/60);
            document.getElementById('clockTime').innerText = `${String(fLoc.hour).padStart(2,'0')}:${String(fLoc.minute).padStart(2,'0')}`;
            document.getElementById('statusLabel').innerText = focus.name;

            ctx.clearRect(0,0,500,500); ctx.save(); ctx.translate(250, 250);
            
            // ç¹ªè£½åˆ»åº¦æ•¸å­—
            ctx.font = "24px Futura"; ctx.fillStyle = "rgba(255,255,255,0.3)"; ctx.textAlign = "center"; ctx.textBaseline = "middle";
            for(let i=1; i<=12; i++) { const ang = i * Math.PI / 6 - Math.PI / 2; ctx.fillText(i, Math.cos(ang)*220, Math.sin(ang)*220); }

            friends.forEach(f => {
                const pLoc = getZonedTime(travelTime, f.zone), isSelected = f.id === selectedId;
                const ang = ((pLoc.hour % 12) + pLoc.minute/60) * Math.PI / 6 - Math.PI / 2;
                const dayDiff = Math.round(pLoc.absDay - fLoc.absDay);
                const isWork = pLoc.hour >= 9 && pLoc.hour < 17;
                let color = isSelected ? "#F54927" : (pLoc.hour <12 ? "white" : "rgba(100,100,100,0.8)");
                
                ctx.save(); 
                ctx.rotate(ang);

                // WORK å‘¼å¸å…‰é‚è¼¯
                if (showWorkMode && isWork) {
                    ctx.shadowBlur = 5 + (pulse * 15);
                    ctx.shadowColor = color;
                }

                ctx.strokeStyle = color; 
                ctx.lineWidth = isSelected ? 5 : 2.5; 
                ctx.lineCap = "round";
                ctx.beginPath(); ctx.moveTo(0,0); ctx.lineTo(165,0); ctx.stroke();
                
                // æ¨™ç±¤æ–‡å­—
                ctx.rotate(-ang); 
                ctx.shadowBlur = 0; // æ–‡å­—ä¸ç™¼å…‰
                ctx.fillStyle = isSelected ? "white" : color;
                ctx.font = isSelected ? "bold 16px Arial" : "13px Arial";
                ctx.fillText(`${(showWorkMode && isWork)?"ğŸ’¼ ":""}${f.name}${dayDiff!==0?` ${dayDiff>0?'+':''}${dayDiff}D`:''}`, Math.cos(ang)*195, Math.sin(ang)*195);
                ctx.restore();
            });
            ctx.restore(); requestAnimationFrame(animate);
        }

        init();
    </script>
</body>
</html>
